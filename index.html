<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Earthquakes in Japan</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web|Oswald" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/c3.min.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Titillium Web', serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #info {
            z-index: 1000;
            position: absolute;
            width: 500px;
            top: 1%;
            bottom: 1%;
            left: .5%;
            padding: 40px 15px 40px 15px; /* CHANGED: was 900px bottom padding */
            background: #343a40;
            color: white;
            overflow-y: auto; /* NEW: allows scrolling if charts exceed height */
        }

        /* social media icons */
        #info a {
            color: lightgray;
        }

        #info a:hover {
            color: white;
            opacity: 0.3;
        }

        #title {
            font-size: 25px;
            font-family: 'Oswald', sans-serif;
        }

        /* social media icons */
        #title span {
            font-size: 14px;
            float: right;
            margin-right: 10px;
        }

        #desc {
            text-align: center;
            color: lightgray;
            font-size: medium;
            font-weight: bold;
            margin-bottom: 0px;
        }

        #earthquake-count {
            margin: 0;
            text-align: center;
            color: orange;
            font-size: 50px;
        }

        #earthquake-chart {
            margin-top: 15px;
        }

        /* NEW: spacing for added charts */
        #bar-chart,
        #area-chart {
            margin-top: 25px;
        }

        #footer {
            margin-top: 25px;
            font-size: 13px;
            line-height: 150%;
            color: lightgray;
        }

        /* the layout of the legend panel */
        #legend {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 110px;
            background: #fff;
            margin-right: 20px;
            margin-bottom: 40px;
            padding: 10px 20px 10px 10px;
            border-radius: 3px;
            text-align: center;
            font-family: 'Open Sans', sans-serif;
        }

        /* each line for a break */
        .break {
            position: relative;
            margin: 0px;
            padding: 0px;
        }

        /* basic style for a dot/circle */
        .dot {
            display: inline-block;
            margin-top: 5px;
            border-radius: 50%;
            opacity: 0.6;
        }

        /* the label for the dot */
        .dot-label {
            position: absolute;
            top: 0;
            right: 0;
            font-style: italic;
        }
    </style>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/c3.min.js"></script>
</head>

<body>
    <div id="info">
        <div id="title">
            Earthquakes in Japan - September 2017
            <span><a href="https://twitter.com/UW" target="_blank"><i class="bi bi-twitter"></i></a></span>
            <span><a href="https://github.com/jakobzhao/geog458" target="_blank"><i class="bi bi-github"></i></a></span>
            <span id="reset"><a href="#">reset</a></span>
        </div>

        <div id="count" class="card">
            <h5 id="desc"> # Earthquakes in the displaying region</h5>
            <p id="earthquake-count"></p>
        </div>

        <!-- Existing coordinated chart -->
        <div id="earthquake-chart"></div>

        <!-- NEW: extra bar chart -->
        <div id="bar-chart"></div>

        <!-- NEW: stacked area chart -->
        <div id="area-chart"></div>

        <div id="footer">
            Hi TA! Thank you for helping out and being available to help out whenever either me
            or the rest of my classmates need it! :D
        </div>
    </div>

    <div id="map"></div>
    <div id="legend"></div>

    <script>
        // assign the access token
        mapboxgl.accessToken =
            'pk.eyJ1IjoiZHZpbGxhNCIsImEiOiJjbWt4bWV4cjQwYmMwM2RvaGV0djVuNnc5In0.dFzOaM3JOKFZQOUO-CCEKQ';

        // declare the map object
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            zoom: 5,
            minZoom: 5,
            center: [138, 38]
        });

        // declare the coordinated chart as well as other variables.
        let earthquakeChart = null,
            magnitude = {},
            numEarthquakes = 0;

        // NEW: extra charts
        let barChart = null;
        let areaChart = null;

        // create a few constant variables.
        const grades = [4, 5, 6],
            colors = ['rgb(208,209,230)', 'rgb(103,169,207)', 'rgb(1,108,89)'],
            radii = [5, 15, 20];

        // create the legend object and anchor it to the html element with id legend.
        const legend = document.getElementById('legend');

        //set up legend grades content and labels
        let labels = ['<strong>Magnitude</strong>'],
            vbreak;

        //iterate through grades and create a scaled circle and label for each
        for (var i = 0; i < grades.length; i++) {
            vbreak = grades[i];
            dot_radii = 2 * radii[i];
            labels.push(
                '<p class="break"><i class="dot" style="background:' + colors[i] + '; width: ' + dot_radii +
                'px; height: ' + dot_radii + 'px; "></i> <span class="dot-label" style="top: ' + dot_radii / 2 +
                'px;">' + vbreak + '</span></p>'
            );
        }

        const source =
            '<p style="text-align: right; font-size:10pt">Source: <a href="https://earthquake.usgs.gov/earthquakes/">USGS</a></p>';

        legend.innerHTML = labels.join('') + source;

        // define the asynchronous function to load geojson data.
        async function geojsonFetch() {
            let response;
            response = await fetch('assets/earthquakes.geojson');
            earthquakes = await response.json();

            map.on('load', () => {
                map.addSource('earthquakes', {
                    type: 'geojson',
                    data: earthquakes
                });

                map.addLayer({
                        'id': 'earthquakes-point',
                        'type': 'circle',
                        'source': 'earthquakes',
                        'minzoom': 5,
                        'paint': {
                            'circle-radius': {
                                'property': 'mag',
                                'stops': [
                                    [grades[0], radii[0]],
                                    [grades[1], radii[1]],
                                    [grades[2], radii[2]]
                                ]
                            },
                            'circle-color': {
                                'property': 'mag',
                                'stops': [
                                    [grades[0], colors[0]],
                                    [grades[1], colors[1]],
                                    [grades[2], colors[2]]
                                ]
                            },
                            'circle-stroke-color': 'white',
                            'circle-stroke-width': 1,
                            'circle-opacity': 0.6
                        }
                    },
                    'waterway-label'
                );

                // click on each dot to view magnitude in a popup
                map.on('click', 'earthquakes-point', (event) => {
                    new mapboxgl.Popup()
                        .setLngLat(event.features[0].geometry.coordinates)
                        .setHTML(`<strong>Magnitude:</strong> ${event.features[0].properties.mag}`)
                        .addTo(map);
                });

                // coordinated chart relevant operations
                magnitudes = calEarthquakes(earthquakes, map.getBounds());
                numEarthquakes = magnitudes[4] + magnitudes[5] + magnitudes[6];
                document.getElementById("earthquake-count").innerHTML = numEarthquakes;

                x = Object.keys(magnitudes);
                x.unshift("mag")
                y = Object.values(magnitudes);
                y.unshift("#")

                // generate the coordinated bar chart
                earthquakeChart = c3.generate({
                    size: {
                        height: 350,
                        width: 460
                    },
                    data: {
                        x: 'mag',
                        columns: [x, y],
                        type: 'bar',
                        colors: {
                            '#': (d) => {
                                return colors[d["x"]];
                            }
                        },
                        onclick: function (d) {
                            let floor = parseInt(x[1 + d["x"]]),
                                ceiling = floor + 1;

                            map.setFilter('earthquakes-point',
                                ['all',
                                    ['>=', 'mag', floor],
                                    ['<', 'mag', ceiling]
                                ]);
                        }
                    },
                    axis: {
                        x: {
                            type: 'category',
                        },
                        y: {
                            tick: {
                                values: [10, 20, 30, 40]
                            }
                        }
                    },
                    legend: {
                        show: false
                    },
                    bindto: "#earthquake-chart"
                });
            });

            map.on('idle', () => {
                magnitudes = calEarthquakes(earthquakes, map.getBounds());
                numEarthquakes = magnitudes[4] + magnitudes[5] + magnitudes[6];
                document.getElementById("earthquake-count").innerHTML = numEarthquakes;

                x = Object.keys(magnitudes);
                x.unshift("mag")
                y = Object.values(magnitudes);
                y.unshift("#")

                if (earthquakeChart) {
                    earthquakeChart.load({
                        columns: [x, y]
                    });
                }
            });
        }

        // call the geojson loading function
        geojsonFetch();

        function calEarthquakes(currentEarthquakes, currentMapBounds) {
            let magnitudesClasses = {
                4: 0,
                5: 0,
                6: 0
            };
            currentEarthquakes.features.forEach(function (d) {
                if (currentMapBounds.contains(d.geometry.coordinates)) {
                    magnitudesClasses[Math.floor(d.properties.mag)] += 1;
                }
            })
            return magnitudesClasses;
        }

        // capture the element reset and add a click event to it.
        const reset = document.getElementById('reset');
        reset.addEventListener('click', event => {
            map.flyTo({
                zoom: 5,
                center: [138, 38]
            });
            map.setFilter('earthquakes-point', null)
        });

        // NEW CHART 2: extra bar chart
        barChart = c3.generate({
            bindto: "#bar-chart",
            size: { height: 220, width: 460 },
            data: {
                columns: [
                    ['data1', 30, 200, 100, 400, 150, 250],
                    ['data2', 130, 100, 140, 200, 150, 50]
                ],
                type: 'bar'
            },
            bar: {
                width: { ratio: 0.5 }
            }
        });

        setTimeout(function () {
            barChart.load({
                columns: [
                    ['data3', 130, -150, 200, 300, -200, 100]
                ]
            });
        }, 1000);

        //stacked area chart
        areaChart = c3.generate({
            bindto: "#area-chart",
            size: { height: 220, width: 460 },
            data: {
                columns: [
                    ['data1', 300, 350, 300, 0, 0, 120],
                    ['data2', 130, 100, 140, 200, 150, 50]
                ],
                types: {
                    data1: 'area-spline',
                    data2: 'area-spline'
                },
                groups: [['data1', 'data2']]
            },
            axis: {
                x: { type: 'category' }
            }
        });
    </script>
</body>

</html>